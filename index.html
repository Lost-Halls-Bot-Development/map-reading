<!doctype html>
<html>

<head>
    <link href="ui.css" type="text/css" rel="stylesheet" />
    <link href="dpad.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="mapreading.js"></script>
    <script>
        var lhmap = new LHMap();
        var callback = function() {
            var dp = document.getElementsByClassName("d-pad")[0];
            dp.style.left = LHMap.settings.mousepadposition.value.left + "px";
            dp.style.top = LHMap.settings.mousepadposition.value.top + "px";
            dp.style.display = LHMap.settings.showmousepad.value ? "block" : "none";
            document.getElementById('map').appendChild(lhmap.canvas);
            document.getElementById('pots').appendChild(lhmap.displaypots);
            document.getElementById('defenders').appendChild(lhmap.displaydefenders);
            document.getElementById('ratio').appendChild(lhmap.displayratio);
            document.getElementById('gpots').appendChild(lhmap.globalpots);
            document.getElementById('gdefenders').appendChild(lhmap.globaldefenders);
            document.getElementById('gratio').appendChild(lhmap.globalratio);
            document.querySelector("#settings-modal .modal-body").appendChild(LHMap.settings.generateTable());
            //document.getElementById('open-copy-mdl').addEventListener('click', function() {
            //    var img = document.querySelector("#copy-modal img");
            //    img.src = lhmap.canvas.toDataURL();
            //})
            document.querySelectorAll(".close").forEach(e => {
                e.addEventListener('click', function(evt) {
                    document.querySelector(evt.target.dataset.for).style.display = "none";
                });
            });
            document.querySelectorAll(".open-modal").forEach(e => {
                e.addEventListener('click', function(evt) {
                    document.querySelector(evt.target.dataset.for).style.display = "block";
                });
            });

            document.addEventListener('copy', function(evt) {
                document.getElementById('copy-modal').style.display = 'none';
            });

            window.addEventListener('click', function(evt) {
                if (evt.target.classList.contains("modal")) {
                    evt.target.style.display = "none";
                }
            });

            window.addEventListener('keyup', e => {
                var keymodal = document.getElementById("keybind-modal");
                if (keymodal.style.display == "block") {
                    if (e.key == "Escape")
                        LHMap.settings[keymodal.dataset.key].value = "None";
                    else {
                        LHMap.settings[keymodal.dataset.key].value = e.key;

                        var values = Object.values(LHMap.settings);
                        for (var obj in values) {
                            if (values[obj] != LHMap.settings[keymodal.dataset.key] &&
                                values[obj].value == e.key)
                                values[obj].value = "None";
                        }
                    }
                    LHMap.settings.save();

                    document.getElementById("keybind-" + keymodal.dataset.key)
                    keymodal.style.display = "none";

                    var table = document.querySelector("#settings-modal table");
                    table.remove();
                    document.querySelector("#settings-modal .modal-body").appendChild(LHMap.settings.generateTable());
                }
            });

            document.getElementsByClassName('d-pad')[0].addEventListener('dragstart', e => {
                var mid = document.querySelector(".d-pad .center");
                if (e.target.querySelector(":hover") !== mid) {
                    e.preventDefault();
                    return false;
                }
                var style = window.getComputedStyle(e.target, null);
                e.dataTransfer.setData("text/plain", (parseInt(style.getPropertyValue("left"), 10) - e.clientX) + "," +
                    (parseInt(style.getPropertyValue("top"), 10) - e.clientY));
            }, false);
            window.addEventListener('dragover', e => {
                e.preventDefault();
                return false;
            }, false);
            window.addEventListener('drop', e => {
                var offset = e.dataTransfer.getData("text/plain").split(',');
                var dpad = document.getElementsByClassName("d-pad")[0];
                dpad.style.left = e.clientX + parseInt(offset[0], 10) + 'px';
                dpad.style.top = e.clientY + parseInt(offset[1], 10) + 'px';

                LHMap.settings.mousepadposition.value.top = e.clientY + parseInt(offset[1], 10);
                LHMap.settings.mousepadposition.value.left = e.clientX + parseInt(offset[0], 10);
                LHMap.settings.save();

                e.preventDefault();
                return false;
            }, false);


            if (Settings.settingsChanged)
                document.getElementById("settings-changed-modal").style.display = "block";
        };

        if (
            document.readyState === "complete" ||
            (document.readyState !== "loading" && !document.documentElement.doScroll)
        ) {
            callback();
        } else {
            document.addEventListener("DOMContentLoaded", callback);
        }

        function showImage() {
            var win = window.open(null, "_blank");
            win.document.write(`<iframe src="${lhmap.canvas.toDataURL('image/png')}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        }
    </script>
</head>

<body>
    <main>
        <div id="map">

        </div>
        <div id="display">
            <div id="sessionstats">
                <h3>Session Stats:</h3>
                <div id="pots">
                    <div>Pots:</div>
                </div><br>
                <div id="defenders">
                    <div>Defenders:</div>
                </div><br>
                <div id="ratio">
                    <div>Pot Ratio:</div>
                </div>
            </div>

            <div id="globalstats">
                <h3>All Time Stats:</h3>
                <div id="gpots">
                    <div>Pots:</div>
                </div><br>
                <div id="gdefenders">
                    <div>Defenders:</div>
                </div><br>
                <div id="gratio">
                    <div>Pot Ratio:</div>
                </div>
            </div>
            <div id="buttons">
                <input type="button" data-for="#settings-modal" class="open-modal" type="button" value="Options" />
                <input type="button" onclick="lhmap.setup()" type="button" value="New Map" />
                <!--<button type="button" data-for="#copy-modal" class="open-modal" id="open-copy-mdl">Copy</button>-->
                <input type="button" onclick="showImage()" value="Copy" />
            </div>
            <div class="d-pad" draggable="true">
                <a class="up arrow" onclick="lhmap.onUp(); lhmap.paint()"></a>
                <a class="right arrow" onclick="lhmap.onRight(); lhmap.paint()"></a>
                <a class="down arrow" onclick="lhmap.onDown(); lhmap.paint()"></a>
                <a class="left arrow" onclick="lhmap.onLeft(); lhmap.paint()"></a>
                <a class="center"></a>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" data-for="#settings-modal">&times;</span>
                <h2>Settings</h2>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer"></div>
        </div>
    </div>

    <div id="copy-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" data-for="#copy-modal">&times;</span>
                <h2>Copy Map</h2>
            </div>

            <div class="modal-body">
                <img src="#" width="900" height="900" id="map-copy" />
            </div>
            <div class="modal-footer">
                <i>Right click the image and select "Copy image"</i>
            </div>
        </div>
    </div>

    <div id="keybind-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" data-for="#keybind-modal">&times;</span>
                <h2>Change Keybind For: <span></span></h2>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">Enter the key you want to change the keybind to. <span id="escape-id">Escape</span> will disable the keybind.</div>
        </div>
    </div>
    <div id="settings-changed-modal" class="modal">
        <div class="modal-content">
            <div class="Modal-header">
                <span class="close" data-for="#settings-changed-modal">&times;</span>
                <h2>Settings Version Changed</h2>
            </div>
            <div class="modal-body">
                This is either your first time running this program, or an update requires the reset of settings. If you had any personalized settings, you will need to set them again. Sorry for the inconvenience. This does not affect your life-time pots & defenders
                hit.
            </div>
        </div>
    </div>

</body>

</html>